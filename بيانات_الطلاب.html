<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>بيانات الطلاب</title>
    <link rel="stylesheet" href="القالب_المشترك2.css">
</head>
<body>
    <header style="position: relative;">
        <div class="container">
            <div class="menu-icon" id="menu-toggle">☰</div>
            <h1>بيانات الطلاب</h1>
            <ul id="dropdown-menu" class="hidden">
                <li><a href="إضافة_طالب.html">إضافة طالب جديد</a></li>
            </ul>
        </div>
    </header>

    <div class="container">
        <h1>قائمة الطلاب المسجلين</h1>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="ابحث بالرقم التسلسلي، رقم اللوحة، أو رقم الهيكل...">
            <button id="searchButton">بحث</button>
        </div>
        <div id="studentTableContainer">
            <p id="loadingMessage">جارٍ تحميل بيانات الطلاب...</p>
            <p id="noStudentsMessage" style="display:none;">لا توجد بيانات طلاب لعرضها.</p>
            <table id="studentsTable" class="students-table" style="display:none;">
                <thead>
                    <tr>
                        <th>الرقم التسلسلي</th>
                        <th>رقم اللوحة</th>
                        <th>رقم الهيكل</th>
                        <th>اللون</th>
                        <th>الشركة الصانعة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <footer>
        <div class="container">
            جميع الحقوق محفوظة - البوابة الوطنية الداعمة للمجتمع البلدي © 2023
        </div>
    </footer>

    <script>
        const studentTableBody = document.querySelector('#studentsTable tbody');
        const loadingMessage = document.getElementById('loadingMessage');
        const noStudentsMessage = document.getElementById('noStudentsMessage');
        const studentsTable = document.getElementById('studentsTable');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');

        // دالة لجلب وعرض بيانات الطلاب
        async function fetchStudents(searchTerm = '') {
            loadingMessage.style.display = 'block';
            studentsTable.style.display = 'none';
            noStudentsMessage.style.display = 'none';
            studentTableBody.innerHTML = ''; // مسح أي بيانات سابقة

            try {
                // *** تحديث مسار الدالة لجلب جميع الطلاب ***
                const url = searchTerm ? `/netlify/functions/getStudents?search=${encodeURIComponent(searchTerm)}` : '/netlify/functions/getStudents';
                const response = await fetch(url);
                const students = await response.json();

                if (response.ok && students.length > 0) {
                    students.forEach(student => {
                        const row = studentTableBody.insertRow();
                        row.insertCell().textContent = student.serial_number || 'غير متوفر';
                        row.insertCell().textContent = student.plate_number || 'غير متوفر';
                        row.insertCell().textContent = student.chassis_number || 'غير متوفر';
                        row.insertCell().textContent = student.color || 'غير متوفر';
                        row.insertCell().textContent = student.manufacturer || 'غير متوفر';

                        const actionsCell = row.insertCell();

                        // زر تعديل
                        const editButton = document.createElement('button');
                        editButton.textContent = 'تعديل';
                        editButton.classList.add('edit-btn');
                        editButton.onclick = () => {
                            window.location.href = `تعديل_بيانات_الطالب.html?id=${student._id}`;
                        };
                        actionsCell.appendChild(editButton);

                        // زر طباعة الشهادة الأولى
                        const printCertOneButton = document.createElement('button');
                        printCertOneButton.textContent = 'شهادة (HTML)';
                        printCertOneButton.classList.add('print-btn');
                        printCertOneButton.onclick = () => {
                            // *** تحديث مسار الدالة لشهادة HTML (Certificate One) ***
                            window.open(`/netlify/functions/generateCertificateOne1?id=${student._id}`, '_blank');
                        };
                        actionsCell.appendChild(printCertOneButton);

                        // زر طباعة الشهادة الثانية
                        const printCertTwoButton = document.createElement('button');
                        printCertTwoButton.textContent = 'شهادة (صورة)';
                        printCertTwoButton.classList.add('print-image-btn');
                        printCertTwoButton.onclick = () => {
                            // *** تحديث مسار الدالة لشهادة الصورة (Certificate Two) ***
                            // نستخدم المسار "الأنيق" الذي سيتم إعادة توجيهه بواسطة vercel.json
                            window.open(`/certificate/${student._id}`, '_blank');
                        };
                        actionsCell.appendChild(printCertTwoButton);

                        // زر حذف الطالب
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'حذف';
                        deleteButton.classList.add('delete-btn');
                        deleteButton.setAttribute('data-id', student._id); // تخزين ID في خاصية data-id
                        actionsCell.appendChild(deleteButton);
                    });
                    loadingMessage.style.display = 'none';
                    studentsTable.style.display = 'table';
                } else {
                    loadingMessage.style.display = 'none';
                    noStudentsMessage.style.display = 'block';
                    studentsTable.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching students:', error);
                loadingMessage.style.display = 'none';
                noStudentsMessage.textContent = 'حدث خطأ أثناء تحميل البيانات.';
                noStudentsMessage.style.display = 'block';
                studentsTable.style.display = 'none';
            }
        }

        // دالة حذف الطالب
        async function deleteStudent(studentId) {
            if (!confirm('هل أنت متأكد أنك تريد حذف هذا الطالب؟')) {
                return; // إلغاء الحذف إذا لم يؤكد المستخدم
            }

            try {
                // *** استدعاء دالة Vercel Function الجديدة للحذف ***
                const response = await fetch('/netlify/functions/deleteStudent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: studentId }) // إرسال المعرف في جسم الطلب
                });

                const result = await response.json();

                if (response.ok) {
                    alert('تم حذف الطالب بنجاح!');
                    fetchStudents(); // إعادة تحميل الطلاب بعد الحذف
                } else {
                    alert(`فشل الحذف: ${result.error || 'خطأ غير معروف'}`);
                    console.error('Error deleting student:', result.error);
                }
            } catch (error) {
                console.error('Network error during deletion:', error);
                alert('حدث خطأ في الاتصال أثناء محاولة الحذف.');
            }
        }

        // إضافة مستمع لزر البحث
        searchButton.addEventListener('click', () => {
            const searchTerm = searchInput.value.trim();
            fetchStudents(searchTerm);
        });

        // إضافة مستمع لحدث "Enter" في حقل البحث
        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                searchButton.click(); // محاكاة النقر على زر البحث
            }
        });

        // إضافة مستمع عام للنقر للتعامل مع أزرار الحذف
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('delete-btn')) {
                const studentId = event.target.dataset.id;
                deleteStudent(studentId);
            }
        });

        // جلب الطلاب عند تحميل الصفحة لأول مرة
        window.onload = fetchStudents;

        // منطق القائمة المنسدلة (شريط التنقل)
        const menuToggle = document.getElementById('menu-toggle');
        const dropdownMenu = document.getElementById('dropdown-menu');

        menuToggle.addEventListener('click', () => {
            dropdownMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', (event) => {
            if (!menuToggle.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>