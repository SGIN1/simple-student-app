<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>بيانات الطلاب</title>
    <link rel="stylesheet" href="القالب_المشترك2.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            direction: rtl; /* للتأكد من الاتجاه اليمين لليسار */
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        th {
            background-color: #f2f2f2;
        }
        .no-results {
            text-align: center;
            color: #888;
            margin-top: 20px;
        }
        .actions button, .actions a {
            padding: 5px 10px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            color: white;
            display: inline-block;
        }
        .edit-btn { background-color: #007bff; }
        .delete-btn { background-color: #dc3545; }
        .print-btn { background-color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>بيانات الطلاب</h1>
        <div class="add-new">
            <a href="إضافة_طالب.html">إصدار جديد</a>
        </div>

        <div class="search-form">
            <input type="text" id="search_residency" placeholder="ابحث برقم الإقامة">
        </div>

        <table id="students_table">
            <thead>
                <tr>
                    <th>المعرف</th>
                    <th>الرقم التسلسلي</th>
                    <th>رقم الإقامة</th>
                    <th>الرقم التسلسلي للوثيقة</th>
                    <th>رقم اللوحة</th>
                    <th>تاريخ الفحص</th>
                    <th>الشركة الصانعة</th>
                    <th>تاريخ انتهاء الفحص</th>
                    <th>تاريخ انتهاء الفحص</th>
                    <th>نوع السيارة</th>
                    <th>قراءة العداد</th>
                    <th>رقم الهيكل</th>
                    <th>طراز المركبة</th>
                    <th>اللون</th>
                    <th>الرقم التسلسلي (مكرر)</th>
                    <th>تاريخ الإضافة</th>
                    <th>الإجراءات</th>
                    <th>الإجراءات1</th>
                    <th>عرض الشهادة الأولى</th>
                    <th>عرض الشهادة الثانية</th>
                </tr>
            </thead>
            <tbody id="students_tbody">
            </tbody>
        </table>

        <p id="no_results" class="no-results" style="display:none;">لا يوجد طلاب بهذا الرقم للإقامة.</p>
        <div id="certificateContainer"></div>
    </div>

    <footer>
        <div class="container">
            جميع الحقوق محفوظة - البوابة الوطنية الداعمة للمجتمع البلدي © 2023
        </div>
    </footer>

    <script>
        const searchInput = document.getElementById('search_residency');
        const studentsTable = document.getElementById('students_table');
        const studentsTbody = document.getElementById('students_tbody');
        const noResultsMessage = document.getElementById('no_results');
        const certificateContainer = document.getElementById('certificateContainer');

        let allStudents = [];

        async function fetchStudents(searchTerm = '') {
            studentsTbody.innerHTML = '';
            noResultsMessage.style.display = 'none';

            // ****** مسار Vercel API الصحيح لـ getStudent.js ******
            let url = '/api/getStudent';
            if (searchTerm) {
                url += `?search=${encodeURIComponent(searchTerm)}`;
            }

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    allStudents = data;
                    renderStudentsTable(allStudents);
                } else {
                    console.error('فشل في جلب بيانات الطلاب:', data.error || 'حدث خطأ غير معروف');
                    studentsTbody.innerHTML = '<tr><td colspan="19">فشل في تحميل بيانات الطلاب.</td></tr>';
                }
            } catch (error) {
                console.error('خطأ في جلب بيانات الطلاب:', error);
                studentsTbody.innerHTML = '<tr><td colspan="19">حدث خطأ أثناء محاولة تحميل بيانات الطلاب.</td></tr>';
            }
        }

        function renderStudentsTable(studentsToRender) {
            studentsTbody.innerHTML = '';

            if (studentsToRender.length > 0) {
                noResultsMessage.style.display = 'none';

                // لا داعي لـ .reverse() هنا لأن الترتيب يتم في الـ API الآن
                const displayStudents = studentsToRender;

                displayStudents.forEach(student => {
                    const row = studentsTbody.insertRow();
                    row.insertCell().textContent = student.id;
                    row.insertCell().textContent = student.serial_number;
                    row.insertCell().textContent = student.residency_number;
                    row.insertCell().textContent = student.document_serial_number || '';
                    row.insertCell().textContent = student.plate_number || '';
                    row.insertCell().textContent = student.inspection_date || '';
                    row.insertCell().textContent = student.manufacturer || '';
                    row.insertCell().textContent = student.inspection_expiry_date || '';
                    row.insertCell().textContent = student.car_type || '';
                    row.insertCell().textContent = student.counter_reading || '';
                    row.insertCell().textContent = student.chassis_number || '';
                    row.insertCell().textContent = student.vehicle_model || '';
                    row.insertCell().textContent = student.color || '';
                    row.insertCell().textContent = student.serial_number_duplicate || '';
                    row.insertCell().textContent = student.created_at;

                    const editCell = row.insertCell();
                    editCell.classList.add('actions');
                    // ****** مسار ملف HTML في مجلد public ******
                    editCell.innerHTML = `<a href="تعديل_الطالب.html?id=${student.id}" class="edit-btn">تعديل</a>`;

                    const deleteCell = row.insertCell();
                    deleteCell.classList.add('actions');
                    deleteCell.innerHTML = `<button class="delete-btn" onclick="deleteStudent('${student.id}')">حذف</button>`;

                    const printCellOne = row.insertCell();
                    // ****** مسار Vercel API الصحيح لدالة الشهادة الأولى ******
                    printCellOne.innerHTML = `<button class="print-btn" onclick="showCertificate('/api/generateCertificateOne1?id=${student.id}')">عرض الأولى</button>`;

                    const printCellTwo = row.insertCell();
                    const certificateButtonTwo = document.createElement('button');
                    certificateButtonTwo.textContent = 'عرض الثانية';
                    // ****** مسار Vercel API الصحيح لدالة الشهادة الثانية (مع إعادة توجيه في vercel.json) ******
                    certificateButtonTwo.addEventListener('click', () => {
                        const certificateUrlTwo = `/certificate/${student.id}`; // هذا سيعتمد على vercel.json
                        window.open(certificateUrlTwo, '_blank');
                    });
                    printCellTwo.appendChild(certificateButtonTwo);
                });
            } else {
                studentsTbody.innerHTML = '<tr><td colspan="19">لا يوجد أي طلاب مسجلين.</td></tr>';
            }
        }

        async function deleteStudent(studentId) {
            if (!confirm('هل أنت متأكد أنك تريد حذف هذا الطالب؟')) {
                return;
            }
            try {
                // ****** مسار Vercel API الصحيح لدالة الحذف (افترض وجودها) ******
                const response = await fetch(`/api/deleteStudent?id=${studentId}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    alert('تم حذف الطالب بنجاح!');
                    fetchAndDisplayStudents();
                } else {
                    const errorData = await response.json();
                    alert(`فشل الحذف: ${errorData.error || 'خطأ غير معروف'}`);
                }
            } catch (error) {
                console.error('خطأ في عملية الحذف:', error);
                alert('حدث خطأ أثناء محاولة الحذف.');
            }
        }

        window.deleteStudent = deleteStudent;
        window.showCertificate = showCertificate;

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            fetchAndDisplayStudents(searchTerm);
        });

        document.addEventListener('DOMContentLoaded', fetchStudents);

        function showCertificate(url) {
            window.open(url, '_blank');
        }
    </script>
</body>
</html>